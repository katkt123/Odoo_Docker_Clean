<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="product_item_area" inherit_id="website_sale.products_item" name="SmileLiving Product Item Area">
        <!-- Use pricelist pricing on /shop (matches product detail). On /shop/wishlist, `get_product_prices` may be missing, so fallback to `_get_sales_prices`. -->
        <xpath expr="//t[@t-set='template_price_vals' and @t-value='get_product_prices(product)']" position="replace">
            <t t-set="template_price_vals" t-value="product._get_sales_prices(request.website)[product.id] if (request and request.httprequest and '/shop/wishlist' in request.httprequest.path) else get_product_prices(product)"/>
        </xpath>

        <!-- On /shop/wishlist, ignore any pre-rendered `product_price` snippet to avoid double price rendering -->
        <xpath expr="//t[@t-if='product_price' and @t-out='product_price']" position="attributes">
            <attribute name="t-if">product_price and not (request and request.httprequest and '/shop/wishlist' in request.httprequest.path)</attribute>
        </xpath>

        <!-- Replace price block with custom VN format (tỷ/triệu) and styling -->
        <xpath expr="(//div[contains(concat(' ', normalize-space(@class), ' '), ' product_price ')])[last()]" position="replace">
            <t t-set="sl_prop" t-value="(smileliving_properties_by_template_id or {}).get(product.id)"/>
            <t t-set="price_map" t-value="template_price_vals or {}"/>
            <t t-set="price_raw" t-value="price_map.get('price') or price_map.get('list_price') or product.list_price or 0.0"/>
            <t t-set="price_val" t-value="float(price_raw) if price_raw else 0.0"/>

            <!-- META INFO above price -->
            <t t-if="sl_prop">
                <div class="sl-meta d-flex align-items-center gap-3 mb-1 text-muted small">
                    <span class="sl-meta-item">
                        <i class="fa fa-bed me-1"/>
                        <t t-esc="sl_prop.bedroom_count or 0"/> PN
                    </span>
                    <span class="sl-meta-item">
                        <i class="fa fa-bath me-1"/>
                        <t t-esc="sl_prop.bathroom_count or 0"/> WC
                    </span>
                    <span t-if="sl_prop.house_direction" class="sl-meta-item">
                        <i class="fa fa-compass me-1"/>
                        <t t-set="dir_label" t-value="dict(sl_prop._fields['house_direction'].selection).get(sl_prop.house_direction)"/>
                        <t t-esc="dir_label"/>
                    </span>
                </div>
            </t>

            <!-- Price + area same row -->
            <t t-if="price_raw is not False">
                <t t-if="price_val &gt;= 100000000">
                    <t t-set="price_fmt" t-value="('{0:.1f}'.format(price_val / 1000000000.0)).replace('.', ',') + ' tỷ'"/>
                </t>
                <t t-elif="price_val &gt;= 1000000">
                    <t t-set="price_fmt" t-value="('{0:.1f}'.format(price_val / 1000000.0)).replace('.', ',') + ' triệu'"/>
                </t>
                <t t-else="">
                    <t t-set="price_fmt" t-value="'{0:,.0f} đ'.format(price_val).replace(',', '.')"/>
                </t>

                <div class="d-flex align-items-center justify-content-between mt-1">
                    <span class="text-danger fw-bold fs-5" t-esc="price_fmt"/>
                    <t t-if="sl_prop and sl_prop.area">
                        <span class="text-muted small">
                            <i class="fa fa-expand me-1 text-secondary"/> Diện tích: 
                            <t t-esc="sl_prop.area"/> m²
                        </span>
                    </t>
                </div>
            </t>
        </xpath>
    </template>
</odoo>
